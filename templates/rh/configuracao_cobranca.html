{% extends 'base.html' %}

{% block title %}Configuração de Cobrança{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Configuração de Cobrança Automática</h1>
        <p class="text-gray-600 mt-1">Configure quando e como enviar cobranças automáticas para candidatos com documentos pendentes</p>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <!-- Status Ativo -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Sistema de Cobrança</h3>
                    <p class="text-sm text-gray-600">Ativar ou desativar o envio automático de cobranças</p>
                </div>
                <!-- Simplificando o toggle para garantir visibilidade -->
                <div class="flex items-center">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="ativo" class="form-checkbox h-5 w-5 text-blue-600 rounded" {% if config.ativo %}checked{% endif %}>
                        <span class="ml-2 text-sm font-medium text-gray-700">
                            {% if config.ativo %}Ativo{% else %}Inativo{% endif %}
                        </span>
                    </label>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Horário de Envio -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Horário de Envio
                    </label>
                    <input type="time" name="horario_envio" value="{% if config.horarios %}{{ config.horarios.0 }}{% endif %}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Dias da Semana -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Dias da Semana para Envio
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="segunda" class="text-blue-600" {% if 0 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Segunda</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="terca" class="text-blue-600" {% if 1 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Terça</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="quarta" class="text-blue-600" {% if 2 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Quarta</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="quinta" class="text-blue-600" {% if 3 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Quinta</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="sexta" class="text-blue-600" {% if 4 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Sexta</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="sabado" class="text-blue-600" {% if 5 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Sábado</span>
                    </label>
                    <label class="flex items-center space-x-2 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" name="domingo" class="text-blue-600" {% if 6 in config.dias_semana %}checked{% endif %}>
                        <span class="text-sm">Domingo</span>
                    </label>
                </div>
            </div>

            <!-- Template da Mensagem -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Template da Mensagem
                </label>
                <textarea name="mensagem_template" rows="6" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="Digite o template da mensagem...">{{ config.mensagem_template }}</textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Use {nome} para o nome do candidato e {documentos} para a lista de documentos pendentes
                </p>
            </div>

            <!-- Adicionando seção de teste de envio de mensagem -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-lg font-medium text-gray-900 mb-3">
                    <i class="fas fa-flask mr-2 text-yellow-600"></i>Teste de Envio
                </h3>
                <p class="text-sm text-gray-600 mb-4">Envie uma mensagem de teste para um candidato específico</p>
                
                <div class="flex flex-col sm:flex-row gap-3 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Selecionar Candidato
                        </label>
                        <select id="candidato_teste" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="">Selecione um candidato...</option>
                            {% for candidato in candidatos_teste %}
                                <option value="{{ candidato.id }}">{{ candidato.nome }} - {{ candidato.documentos_pendentes }} doc(s) pendente(s)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" id="btn_teste_envio" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-paper-plane mr-1"></i> Enviar Teste
                    </button>
                </div>
                
                <div id="resultado_teste" class="mt-3 hidden">
                    <!-- Resultado do teste aparecerá aqui -->
                </div>
            </div>

            <div class="flex justify-between items-center pt-6 border-t">
                <div class="flex space-x-3">
                    <a href="{% url 'historico_cobranca' %}" class="px-4 py-2 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-history mr-1"></i> Ver Histórico
                    </a>
                </div>
                
                <div class="flex space-x-3">
                    <form method="post" action="{% url 'executar_cobranca_manual' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">
                            <i class="fas fa-play mr-1"></i> Executar Agora
                        </button>
                    </form>
                    
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-save mr-1"></i> Salvar Configurações
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Adicionando JavaScript para funcionalidade de teste -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectCandidato = document.getElementById('candidato_teste');
    const btnTeste = document.getElementById('btn_teste_envio');
    const resultadoTeste = document.getElementById('resultado_teste');
    
    // Habilitar/desabilitar botão baseado na seleção
    selectCandidato.addEventListener('change', function() {
        btnTeste.disabled = !this.value;
    });
    
    // Enviar teste
    btnTeste.addEventListener('click', function() {
        const candidatoId = selectCandidato.value;
        if (!candidatoId) return;
        
        // Desabilitar botão durante envio
        btnTeste.disabled = true;
        btnTeste.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Enviando...';
        
        // Fazer requisição AJAX
        fetch('{% url "testar_envio_cobranca" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                candidato_id: candidatoId
            })
        })
        .then(response => response.json())
        .then(data => {
            resultadoTeste.className = 'mt-3 p-3 rounded-md ' + (data.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800');
            resultadoTeste.innerHTML = '<i class="fas fa-' + (data.success ? 'check' : 'times') + ' mr-1"></i>' + data.message;
            resultadoTeste.classList.remove('hidden');
            
            // Reabilitar botão
            btnTeste.disabled = false;
            btnTeste.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Enviar Teste';
        })
        .catch(error => {
            resultadoTeste.className = 'mt-3 p-3 rounded-md bg-red-100 text-red-800';
            resultadoTeste.innerHTML = '<i class="fas fa-times mr-1"></i>Erro ao enviar teste: ' + error.message;
            resultadoTeste.classList.remove('hidden');
            
            // Reabilitar botão
            btnTeste.disabled = false;
            btnTeste.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Enviar Teste';
        });
    });
});
</script>

{% endblock %}
