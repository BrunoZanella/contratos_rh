{% extends 'base.html' %}
{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* VARIÁVEIS DE COR DA EMPRESA */
.page-avaliacoes {
    --primary: #0C4B33; /* Verde principal da empresa */
    --secondary: #167049; /* Um tom de verde um pouco mais claro para gradientes */
    --info: #0D6EFD; /* Azul para o tipo de avaliação e outros destaques */
    --success: var(--primary); /* Usando o verde principal para sucesso */
    --warning: #F7C202; /* Amarelo para status pendente (mantido) */
    --light-bg: #f9fafb;
    --text-muted: #6b7280;
    --danger: #ef4444; /* Mantido para demitir/erro */
    --secondary-badge: #9ca3af; /* Mantido para em análise */
    --card-header-bg: #f0fdf4; /* Fundo muito claro para cards internos */
}

.page-avaliacoes body {
    background: var(--light-bg);
    color: #111827;
    font-family: 'Inter', sans-serif;
}

/* CABEÇALHO */
.page-avaliacoes h2.page-title {
    font-weight: 700;
    /* Gradiente de verde da empresa */
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    margin-bottom: 2.5rem;
}

/* CARD DE FILTRO */
.page-avaliacoes .card.filter-card {
    border: none;
    border-left: 6px solid var(--primary); /* Borda verde */
    border-radius: 0.8rem;
    background: white;
    box-shadow: 0 4px 12px rgba(12, 75, 51, 0.15); /* Sombra mais sutil com o verde */
}

.page-avaliacoes .card.filter-card label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
}

/* Botão Filtrar (Success) */
.page-avaliacoes .card.filter-card .btn-success {
    background: var(--success); /* Verde da empresa */
    border: none;
    transition: 0.3s;
}
.page-avaliacoes .card.filter-card .btn-success:hover {
    background: var(--secondary); /* Um verde um pouco mais escuro no hover */
}

/* TABELA (Desktop/Padrão) */
.page-avaliacoes .table {
    border-radius: 0.8rem;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.page-avaliacoes .table thead {
    /* Gradiente de verde da empresa no cabeçalho da tabela */
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    color: white;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
}
.page-avaliacoes .table-hover tbody tr:hover {
    /* Hover levemente verde/claro */
    background-color: rgba(12, 75, 51, 0.05);
    transition: 0.2s;
}
.page-avaliacoes .table td, 
.page-avaliacoes .table th {
    vertical-align: middle;
    text-align: center;
}

/* BADGES */
.page-avaliacoes .badge.bg-success { background-color: var(--success) !important; } /* Verde para Aprovado/Respondida */
.page-avaliacoes .badge.bg-warning { background-color: var(--warning) !important; color: #333 !important; } /* Amarelo para Pendente */
.page-avaliacoes .badge.bg-danger { background-color: var(--danger) !important; } /* Vermelho para Demitir */
.page-avaliacoes .badge.bg-secondary { background-color: var(--secondary-badge) !important; } /* Cinza para Em análise */
.page-avaliacoes .badge.bg-info { background-color: var(--info) !important; } /* Azul para Tipo de Avaliação */

/* PAGINAÇÃO */
.page-avaliacoes .pagination .page-link {
    color: var(--primary);
}
.page-avaliacoes .pagination .page-item.active .page-link {
    background-color: var(--primary);
    border-color: var(--primary);
}
.page-avaliacoes .pagination .page-item.disabled .page-link {
    color: #6c757d;
}

/* MODAL - ESTILIZAÇÃO ESPECÍFICA */
.modal-header.bg-primary {
    background-color: var(--primary) !important; /* Verde da empresa no cabeçalho do modal */
}
/* Garante que o ícone de fechar fique branco no fundo verde */
.modal-header .btn-close.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%); 
}

/* Card principal de informações do colaborador no modal */
.page-avaliacoes .card.modal-info-card {
    border-left: 5px solid var(--info); /* Borda azul para destaque */
}

.page-avaliacoes .card.modal-info-card .card-title {
    color: var(--primary) !important; /* Título em verde */
}

/* Cards de resposta individual no modal */
.page-avaliacoes .card.modal-answer-card {
    border: 1px solid rgba(12, 75, 51, 0.1); /* Borda sutil verde */
    background: var(--card-header-bg); /* Fundo muito levemente verde */
}

.page-avaliacoes .card.modal-answer-card .fw-bold {
    color: var(--primary); /* Título da pergunta em verde */
}

/* ================================================= */
/* ESTILOS ESPECÍFICOS PARA MOBILE (Tabela -> Cards) */
/* ================================================= */
@media (max-width: 768px) {
    /* Esconde o cabeçalho da tabela */
    .page-avaliacoes .table thead {
        display: none;
    }

    /* Oculta o container responsivo da tabela para facilitar o layout do card */
    .page-avaliacoes .table-responsive {
        overflow-x: visible;
        margin-top: 1rem;
    }

    /* Transforma o corpo da tabela em uma pilha de blocos */
    .page-avaliacoes .table tbody {
        display: block;
        width: 100%;
    }

    /* Remove estilos de tabela e transforma cada linha em um Card */
    .page-avaliacoes .table tr {
        display: block;
        margin-bottom: 1.5rem;
        border: 1px solid var(--text-muted);
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        background: white;
        /* Adiciona um destaque sutil de cor primária na esquerda do card */
        border-left: 4px solid var(--primary);
        cursor: pointer !important; /* Mantém o cursor para indicar que é clicável */
    }
    
    /* Remove a borda no hover (já que o tr virou um card com shadow) */
    .page-avaliacoes .table-hover tbody tr:hover {
        background-color: white;
        transform: translateY(-2px); /* Efeito de elevação */
        transition: 0.2s;
    }

    /* Transforma cada célula (td) em um bloco de informações */
    .page-avaliacoes .table td {
        display: block;
        text-align: left !important;
        padding: 0.3rem 0;
        border: none;
    }

    /* Adiciona o "rótulo" de cada coluna antes do dado em cada célula */
    .page-avaliacoes .table td:before {
        content: attr(data-label); /* Usa o atributo data-label do HTML */
        font-weight: 600;
        color: var(--primary); /* Rótulo em verde */
        display: inline-block;
        width: 120px; /* Largura fixa para alinhar os rótulos */
        min-width: 120px;
        margin-right: 0.5rem;
        font-size: 0.8rem;
        text-transform: uppercase;
    }
    
    /* Ajustes finais para responsividade do filtro */
    .page-avaliacoes .card.filter-card .form-label {
        font-size: 0.8rem;
    }
}
/* ====== CORREÇÃO PARA NÃO SUBLINHAR LINKS DO BASE ====== */
a,
a:hover,
a:focus,
a:active,
button {
    text-decoration: none !important;
}

</style>
{% endblock %}

{% block content %}
<div class="page-avaliacoes">
    <h2 class="page-title">Avaliações de Período de Experiência</h2>

    <div class="card filter-card mb-4 p-3">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-lg-3 col-md-6">
                <label for="gestor" class="form-label">Gestor</label>
                <input type="text" class="form-control form-control-sm" id="gestor" name="gestor"
                       placeholder="Nome do Gestor" value="{{ gestor }}">
            </div>
            <div class="col-lg-3 col-md-6">
                <label for="colaborador" class="form-label">Colaborador</label>
                <input type="text" class="form-control form-control-sm" id="colaborador" name="colaborador"
                       placeholder="Nome do Colaborador" value="{{ colaborador }}">
            </div>
            <div class="col-lg-3 col-md-6">
                <label for="avaliacao_tipo" class="form-label">Tipo de Avaliação</label>
                <select class="form-select form-select-sm" id="avaliacao_tipo" name="primeira_segunda_avaliacao">
                    <option value="">-- Todas --</option>
                    <option value="1" {% if avaliacao_tipo == '1' %}selected{% endif %}>Primeira</option>
                    <option value="2" {% if avaliacao_tipo == '2' %}selected{% endif %}>Segunda</option>
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label for="data_admissao" class="form-label">Data de Admissão</label>
                <input type="date" class="form-control form-control-sm" id="data_admissao"
                       name="data_admissao" value="{{ data_admissao }}">
            </div>
            <div class="col-lg-1 col-md-12 d-grid">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-search me-1"></i> Filtrar
                </button>
            </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered w-100">
            <thead>
                <tr>
                    <th>Gestor</th>
                    <th>Colaborador</th>
                    <th>Data Envio</th>
                    <th>Data Admissão</th>
                    <th>Tipo de Avaliação</th>
                    <th>Status</th>
                    <th>Avaliação</th>
                </tr>
            </thead>
            <tbody>
                {# ✅ CORREÇÃO 1: Loop alterado para page_obj #}
                {% for avaliacao in page_obj %}
                <script>console.log(avaliacao)</script>
                <tr class="avaliacao-row"
                    data-id="{{ avaliacao.id }}"
                    data-colaborador="{{ avaliacao.colaborador }}"
                    data-token="{{ avaliacao.token }}"
                    data-avaliacao_tipo="{{ avaliacao.get_primeira_segunda_avaliacao_display }}"
                    data-admissao="{{ avaliacao.data_admissao|date:'d/m/Y' }}"
                    data-gestor="{{ avaliacao.gestor_avaliador }}"
                    data-data_envio="{{ avaliacao.data_avaliacao|date:'d/m/Y' }}"
                    style="cursor: pointer;">
                    
                    <td class="fw-medium" data-label="Gestor">
                        {# ✅ CORREÇÃO 2: Lógica para truncar nome no mobile #}
                        <span class="d-none d-md-inline">{{ avaliacao.gestor_avaliador }}</span>
                        <span class="d-inline d-md-none">{{ avaliacao.gestor_avaliador|truncatewords:3 }}</span>
                    </td>
                    <td data-label="Colaborador">
                        {# ✅ CORREÇÃO 2: Lógica para truncar nome no mobile #}
                        <span class="d-none d-md-inline">{{ avaliacao.colaborador }}</span>
                        <span class="d-inline d-md-none">{{ avaliacao.colaborador|truncatewords:3 }}</span>
                    </td>
                    <td data-label="Data Envio">{{ avaliacao.data_avaliacao|date:"d/m/Y" }}</td>
                    <td data-label="Data Admissão">{{ avaliacao.data_admissao|date:"d/m/Y" }}</td>
                    <td data-label="Tipo de Avaliação">
                        <span class="badge bg-info text-white">
                            {{ avaliacao.get_primeira_segunda_avaliacao_display }}
                        </span>
                    </td>
                    <td data-label="Status">
                        {% if avaliacao.respondido %}
                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i> Respondida</span>
                        {% else %}
                            <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i> Pendente</span>
                        {% endif %}
                    </td>
                    <td data-label="Resultado">
                        {% if avaliacao.aprova_demite == 1 %}
                            <span class="badge bg-success"><i class="fa-solid fa-check"></i> Aprovado</span>
                        {% elif avaliacao.aprova_demite == 2 %}
                            <span class="badge bg-danger"><i class="fa-solid fa-xmark"></i> Demitir</span>
                        {% else %}
                            <span class="badge bg-secondary">Em análise</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>Nenhuma Avaliação encontrada.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# ✅ CORREÇÃO 3: Adição do Bloco de Paginação #}
    <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Navegação das páginas">
            <ul class="pagination">
                {# Botão ANTERIOR #}
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Anterior</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Anterior</a>
                    </li>
                {% endif %}
    
                {# Informação da página atual #}
                <li class="page-item disabled">
                    <span class="page-link">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {# Botão PRÓXIMO #}
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Próxima</a>
                    </li>
                {% else %}
                     <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Próxima</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>


<div class="modal fade" id="avaliacaoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">📋 Respostas da Avaliação</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBodyContent">
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-xmark me-1"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dicionário de nomes amigáveis
    const nomesCampos = {
        apresenta_iniciativa: "Apresenta iniciativa",
        organizado_atividades: "Organiza atividades",
        adapta_novas_situacoes_clientes: "Adapta-se a novas situações",
        interage_bem_colegas: "Interage bem com colegas",
        aptidao_lideranca: "Aptidão para liderança",
        talento_para_funcao: "Talento para a função",
        pronto_para_colaborar: "Pronto para colaborar",
        resultados_esperados: "Entrega resultados esperados",
        colabora_membros_empresa: "Colabora com os membros da empresa",
        comportamento_etico: "Comportamento ético",
        desiste_facil: "Desiste com facilidade",
        reduz_despesas_desperdicios: "Reduz despesas e desperdícios",
        comunica_claro_coerente: "Comunica-se de forma clara e coerente",
        administra_tempo: "Administra bem o tempo",
        autoconfiante: "É autoconfiante",
        empenho_resultados_grupo: "Empenha-se nos resultados do grupo",
        aceita_opinioes_divergentes: "Aceita opiniões divergentes",
        relutante_decisoes_grupo: "Relutante em decisões de grupo",
        expor_necessidades_perguntas: "Expõe necessidades e faz perguntas",
        assiduo: "Assiduidade",
        aceita_ordens_gestor: "Aceita ordens do gestor",
        sugestao_critica_elogio: "Sugestões, críticas e elogios",
        aprova_demite: "Resultado final"
    };

    // Função para converter notas em texto
    function traduzValor(chave, valor) {
        if (chave === "aprova_demite") {
            if (valor == 1) return "✅ Aprovado";
            if (valor == 2) return "❌ Demitir";
            return "Aguardando Resposta";
        }
        const niveis = {
            1: "Nunca",
            2: "Raramente",
            3: "Às vezes",
            4: "Frequentemente",
            5: "Sempre"
        };
        return niveis[valor] || valor || "-";
    }

    // Clique na linha da tabela
    document.addEventListener('click', async function(e) {
        const row = e.target.closest('.avaliacao-row');
        if (!row) return;

        const token = row.dataset.token;
        if (!token) return console.warn("Token não encontrado na linha.");

        const url = `/pesquisa-details/${token}`; 
        console.log("🔗 Carregando:", url);

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);

            const data = await res.json();
            const modal = new bootstrap.Modal(document.getElementById('avaliacaoModal'));
            const modalBody = document.getElementById('modalBodyContent');

            if (data.error) {
                modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                modal.show();
                return;
            }

            // Cabeçalho da avaliação (Card de Informações Principais)
            let html = `
                <div class="card mb-3 modal-info-card shadow-sm">
                    <div class="card-body bg-light">
                        <h5 class="card-title fw-bold mb-2"><strong>Colaborador:</strong> ${data.colaborador}</h5>
                        <p class="mb-0">
                            <strong>Cargo:</strong> ${data.cargo} <br>
                            <strong>Gestor:</strong> ${data.gestor_avaliador} <br>
                        </p>
                    </div>
                </div>
                <div class="row g-3">
            `;

            // Percorre os campos (Cards de Resposta Individual)
            for (const [chave, valor] of Object.entries(data)) {
                if (['gestor_avaliador','colaborador','cargo','data_admissao','token'].includes(chave)) continue;

                const nomeCampo = nomesCampos[chave] || chave.replace(/_/g, ' ');
                const displayValor = traduzValor(chave, valor);

                html += `
                    <div class="col-md-3">
                        <div class="card h-100 shadow-sm border-0 modal-answer-card">
                            <div class="card-body text-center">
                                <h6 class="fw-bold mb-2">${nomeCampo}</h6>
                                <p class="mb-0 fs-6">${displayValor}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>'; // Fecha .row
            modalBody.innerHTML = html;
            modal.show();

        } catch (err) {
            console.error("❌ Erro no fetch:", err);
            const modal = new bootstrap.Modal(document.getElementById('avaliacaoModal'));
            document.getElementById('modalBodyContent').innerHTML =
                `<div class="alert alert-danger">Erro ao carregar a avaliação. Tente novamente.</div>`;
            modal.show();
        }
    });
});
</script>

{% endblock %}